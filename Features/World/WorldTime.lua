local WorldTime = {}
local Logger = require("Core/Logger")
local Draw = require("UI")
local Cron = require("Vendor/cp2077-cet-kit/Cron")

local timeSystem = Game.GetTimeSystem()

WorldTime.daySpeedMultiplier = { value = 2.0, min = 1.0, max = 10.0, step = 0.5, enabled = false }
WorldTime.nightSpeedMultiplier = { value = 2.0, min = 1.0, max = 10.0, step = 0.5, enabled = false }

WorldTime.toggleFreezeTime = { value = false }
WorldTime.toggleTimeLapse = { value = false }
WorldTime.toggleSyncToSystemClock = { value = false }

WorldTime.timeLapseMultiplier = { value = 2, min = 1, max = 64, step = 1.0 }

local skipState = {
    enabled = false,
    totalStart = 0,
    totalTarget = 0,
    step = 500,
    currentTime = 0,
    days = 0,
    logged = false
}



function WorldTime.GetTime()
    local gameTime = timeSystem:GetGameTime()

    return {
        hours = gameTime:Hours(),
        minutes = gameTime:Minutes(),
        seconds = gameTime:Seconds(),
        -- day = gameTime:Day(), -- Not working idk why
        raw = gameTime
    }
end

function WorldTime.SetGameTime(hours, minutes, seconds)
    timeSystem:SetGameTimeByHMS(hours, minutes, seconds, "EasyTrainerWorldTime")
    Logger.Log(string.format("[EasyTrainerWorldTime] Set game time to %02d:%02d:%02d", hours, minutes, seconds))
end

function WorldTime.SetTimeMorning()   WorldTime.SetGameTime(6, 0, 0) end
function WorldTime.SetTimeNoon()      WorldTime.SetGameTime(12, 0, 0) end
function WorldTime.SetTimeAfternoon() WorldTime.SetGameTime(15, 0, 0) end
function WorldTime.SetTimeEvening()   WorldTime.SetGameTime(18, 0, 0) end
function WorldTime.SetTimeNight()     WorldTime.SetGameTime(22, 0, 0) end

function WorldTime.SkipDays(days, step)
    if not days or days < 1 then days = 1 end
    local current = timeSystem:GetGameTime()
    skipState.totalStart = current:Seconds()
    skipState.totalTarget = skipState.totalStart + (days * 86400)
    skipState.currentTime = 0
    skipState.step = step or 500
    skipState.enabled = true
    skipState.days = days
    skipState.logged = false
end

local function HandleFreezeTime()
    if WorldTime.toggleFreezeTime.value then
        if not WorldTime.frozenTime then
            local current = timeSystem:GetGameTime()
            WorldTime.frozenTime = {
                h = current:Hours(),
                m = current:Minutes(),
                s = current:Seconds()
            }
        end
        timeSystem:SetGameTimeByHMS(WorldTime.frozenTime.h, WorldTime.frozenTime.m, WorldTime.frozenTime.s, "EasyTrainerFreezeTime"
        )
        return true
    else
        WorldTime.frozenTime = nil
    end
end

local function HandleTimeLapse()
    if not WorldTime.toggleTimeLapse.value then return end
    
    local now = timeSystem:GetGameTime()
    local hour = now:Hours()
    local minute = now:Minutes()
    local second = now:Seconds()

    local totalSeconds = hour * 3600 + minute * 60 + second
    totalSeconds = totalSeconds + (10 * WorldTime.timeLapseMultiplier.value)

    local h = math.floor((totalSeconds / 3600) % 24)
    local m = math.floor((totalSeconds % 3600) / 60)
    local s = math.floor(totalSeconds % 60)

    timeSystem:SetGameTimeByHMS(h, m, s, "EasyTrainerTimeLapse")
end


local function HandleSyncToSystemClock()
    if WorldTime.toggleSyncToSystemClock.value then
        local now = os.date("*t")
        WorldTime.SetGameTime(now.hour, now.min, now.sec)
    end
end

local function HandleSkipDays(delta)
    if not skipState.enabled then return end

    skipState.currentTime = skipState.currentTime + (delta * 1000)
    if skipState.currentTime >= 50 then
        skipState.currentTime = 0
        skipState.totalStart = skipState.totalStart + skipState.step

        if skipState.totalStart >= skipState.totalTarget then
            skipState.enabled = false
            if not skipState.logged then
                Logger.Log(string.format("[EasyTrainerWorldTime] Skipped %d day(s)", skipState.days))
                Draw.Notifier.Push(string.format("Skipped %d day(s)", skipState.days))
                skipState.logged = true
            end
            return
        end

        local h = math.floor((skipState.totalStart / 3600) % 24)
        local m = math.floor((skipState.totalStart % 3600) / 60)
        local s = math.floor(skipState.totalStart % 60)
        timeSystem:SetGameTimeByHMS(h, m, s, "EasyTrainerWorldTime")
    end
end

local function HandleFasterTime(delta)
    WorldTime.fasterTimeTick = (WorldTime.fasterTimeTick or 0) + (delta * 1000)
    if WorldTime.fasterTimeTick >= 100 then
        WorldTime.fasterTimeTick = 0

        local now = timeSystem:GetGameTime()
        local hour = now:Hours()
        local minute = now:Minutes()
        local second = now:Seconds()

        local isDay = hour >= 6 and hour < 18
        local isNight = not isDay

        local applyDay = isDay and WorldTime.daySpeedMultiplier.enabled
        local applyNight = isNight and WorldTime.nightSpeedMultiplier.enabled

        if applyDay or applyNight then
            local multiplier = applyDay and WorldTime.daySpeedMultiplier.value or WorldTime.nightSpeedMultiplier.value
            local totalSeconds = hour * 3600 + minute * 60 + second
            totalSeconds = totalSeconds + (10 * multiplier)

            local h = math.floor((totalSeconds / 3600) % 24)
            local m = math.floor((totalSeconds % 3600) / 60)
            local s = math.floor(totalSeconds % 60)

            timeSystem:SetGameTimeByHMS(h, m, s, "EasyTrainerFasterTime")
        end
    end
end




function WorldTime.Update(delta)
    HandleSyncToSystemClock()

    if HandleFreezeTime() then return end

    HandleSkipDays(delta)
    HandleFasterTime(delta)
    HandleTimeLapse()
end


return WorldTime
